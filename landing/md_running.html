<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MFC: Running</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.ico"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MFC
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">High-fidelity multiphase flow simulation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_running.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Running </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md25"></a>
Python Input File</h1>
<p>Python input file <code>input.py</code> defines dependencies and logistics, and input parameters for each simulation case. In this section, details of the input file and how to edit it are described. The user can also leverage the example input files as necessary.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Input parameters</h1>
<p>There are multiple sets of parameters that must be specified in the python input file:</p><ol type="1">
<li>Job scheduler parameters.</li>
<li>Computational domain parameters.</li>
<li>Patch parameters.</li>
<li>Fluid material's parameters.</li>
<li>Simulation algorithm parameters.</li>
<li>Formatted database and structure parameters.</li>
<li>(Optional) Acoustic source parameters.</li>
<li>(Optional) Ensemble-averaged bubble model parameters.</li>
</ol>
<p>Items 7 and 8 are optional sets of parameters that activate the acoustic source model and ensemble-averaged bubble model, respectively. Definition of the parameters is described in the following subsections.</p>
<h2><a class="anchor" id="autotoc_md27"></a>
Job-scheduler parameters</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadRight">Parameter </th><th class="markdownTableHeadCenter">Type </th><th class="markdownTableHeadLeft">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyRight"><code>case_dir</code> </td><td class="markdownTableBodyCenter">String </td><td class="markdownTableBodyLeft">Case script directory  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyRight"><code>run_time_info</code> </td><td class="markdownTableBodyCenter">Logical </td><td class="markdownTableBodyLeft">Output run-time information  </td></tr>
</table>
<ul>
<li><code>case_dir</code> specifies the directory where the python input file is located.</li>
<li><code>run_time_info</code> generates a text file that includes run-time information including the CFL number(s) at each time-step.</li>
</ul>
<h1><a class="anchor" id="autotoc_md28"></a>
Running</h1>
<p>MFC can be run using <code>mfc.sh</code>'s <code>run</code> command. It supports both interactive and batch execution, the latter being designed for multi-socket systems, namely supercomputers, equipped with a scheduler such as PBS, SLURM, and LSF. A full (and updated) list of available arguments can be acquired with <code>./mfc.sh run -h</code>. Example Python input files can be found in the <a href="samples/">samples/</a> directory. They print a Python dictionary containing input parameters for MFC. Their contents, and a guide to filling them out, are documented in the user manual. A commented, tutorial script can also be found in <a href="samples/3D_sphbubcollapse/case.py">samples/3d_sphbubcollapse/</a>.</p>
<p>The skeleton for an input file may look like the following:</p>
<div class="fragment"><div class="line">#!/usr/bin/env python3</div>
<div class="line"> </div>
<div class="line">import json</div>
<div class="line"> </div>
<div class="line"># Configuring case dictionary</div>
<div class="line">print(json.dumps({</div>
<div class="line">  # Insert case parameters here</div>
<div class="line">  ...</div>
<div class="line">}))</div>
</div><!-- fragment --><p>Thus, you can run your case file with Python to view the computed case dictionary that will be processed by MFC when you run. This is particularly useful when computations are done in Python to generate the case.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Interactive Execution</h2>
<p>To run all stages of MFC, that is <a href="src/pre_process_code/">pre_process</a>, <a href="src/simulation_code/">simulation</a>, and <a href="src/post_process_code/">post_process</a> on the sample case <a href="samples/2D_shockbubble/">2D_shockbubble</a>,</p>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py</div>
</div><!-- fragment --><p>If you want to run a subset of the available stages, you can use the <code>-t</code> argument. To use multiple threads, use the <code>-n</code> option along with the number of threads you wish to use. If a (re)build is required, it will be done automatically, with the number of threads specified with the <code>-j</code> option.</p>
<p>For example,</p>
<ul>
<li>Running <a href="src/pre_process_code/">pre_process</a> with 2 cores:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -t pre_process -n 2</div>
</div><!-- fragment --><ul>
<li>Running <a href="src/simulation_code/">simulation</a> and <a href="src/post_process_code/">post_process</a> using 4 cores:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -t simulation post_process -n 4</div>
</div><!-- fragment --><p>Most parameters have sensible defaults which can be overridden in <a href="defaults.yaml">defaults.yaml</a>:</p>
<p><a href="https://github.com/MFlowCode/MFC-develop/blob/d74e714b08562a9f8f815112e05df54c99c8c18f/defaults.yaml#L12-L21">https://github.com/MFlowCode/MFC-develop/blob/d74e714b08562a9f8f815112e05df54c99c8c18f/defaults.yaml#L12-L21</a></p>
<p>On some computer clusters, MFC might select the wrong MPI program to execute your application because it uses a general heuristic for its selection. Notably, <code>srun</code> is known to fail on some SLURM systems when using GPUs or MPI implementations from different vendors, whereas <code>mpirun</code> functions properly. To override and manually specify which MPI program you wish to run your application with, please use the <code>-b &lt;program name&gt;</code> option (i.e <code>--binary</code>).</p>
<p>Additional flags can be appended to the MPI executable call using the <code>-f</code> (i.e <code>--flags</code>) option.</p>
<p>Please refer to <code>./mfc.sh run -h</code> for a complete list of arguments and options, along with their defaults.</p>
<h2><a class="anchor" id="autotoc_md30"></a>
Batch Execution</h2>
<p>The MFC detects which scheduler your system is using and handles the creation and execution of batch scripts. The batch engine is requested with the <code>-e batch</code> option. Whereas the interactive engine can execute all of MFC's codes in succession, the batch engine requires you to only specify one target with the <code>-t</code> option. The number of nodes and GPUs can, respectively be specified with the <code>-N</code> (i.e <code>--nodes</code>) and <code>-g</code> (i.e <code>--gpus-per-node</code>) options.</p>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -e batch -N 2 -n 4 -g 4 -t simulation</div>
</div><!-- fragment --><p>Other useful arguments include:</p>
<ul>
<li><code>-# &lt;job name&gt;</code> to name your job. (i.e <code>--name</code>)</li>
<li><code>-@ sample@example.com</code> to receive emails from the scheduler. (i.e <code>--email</code>)</li>
<li><code>-w hh:mm:ss</code> to specify the job's maximum allowed walltime. (i.e <code>--walltime</code>)</li>
<li><code>-a &lt;account name&gt;</code> to identify the account to be charged for the job. (i.e <code>--account</code>)</li>
<li><code>-p &lt;partition name&gt;</code> to select the job's partition. (i.e <code>--partition</code>)</li>
</ul>
<p>Since some schedulers don't have a standardized syntax to request certain resources, MFC can only provide support for a restricted subset of common configuration options. If MFC fails to execute on your system, or if you wish to adjust how the program runs and resources are requested to be allocated, you are invited to modify the template batch script for your queue system. Upon execution of <code>./mfc.sh run</code>, MFC fills in the template with runtime parameters, to generate the batch file it will submit. These files are located in the <a href="templates/">templates</a> directory. To request GPUs, modification of the template will be required on most systems.</p>
<ul>
<li>Lines that begin with <code>#&gt;</code> are ignored and won't figure in the final batch script, not even as a comment.</li>
<li>Statements of the form <code>${expression}</code> are string-replaced to provide runtime parameters, most notably execution options. They reference the variables in the same format as those under the "run" section of <a href="defaults.yaml">defaults.yaml</a>, replacing <code>-</code> for <code>_</code>. You can perform therein any Python operation recognized by the built-in <code>expr()</code> function.</li>
</ul>
<p>As an example, one might request GPUs on a SLURM system using the following:</p>
<div class="fragment"><div class="line">#SBATCH --gpus=v100-32:{gpus_per_node*nodes}</div>
</div><!-- fragment --><ul>
<li>Statements of the form <code>{MFC::expression}</code> tell MFC where to place the common code, across all batch files, that is required for proper execution. They are not intended to be modified by users.</li>
</ul>
<p><b>Disclaimer</b>: IBM's JSRUN on LSF-managed computers does not use the traditional node-based approach to allocate resources. Therefore, the MFC constructs equivalent resource-sets in task and GPU count.</p>
<h2><a class="anchor" id="autotoc_md31"></a>
Example Runs</h2>
<ul>
<li>Oak Ridge National Laboratory's <a href="https://www.olcf.ornl.gov/summit/">Summit</a>:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -e batch    \</div>
<div class="line">               -N 2 -n 4 -g 4 -t simulation -a &lt;redacted&gt;</div>
</div><!-- fragment --><ul>
<li>University of California, San Diego's <a href="https://www.sdsc.edu/services/hpc/expanse/">Expanse</a>:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -e batch -p GPU -t simulation \</div>
<div class="line">               -N 2 -n 8 -g 8 -f=&quot;--gpus=v100-32:16&quot; -b mpirun –w 00:30:00</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
