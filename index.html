<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MFC: Multi-component Flow Code</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="icon.ico"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MFC
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">High-fidelity multiphase flow simulation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Multi-component Flow Code </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Welcome to MFC! The MFC is a fully-documented parallel simulation software for multi-component, multi-phase, and bubbly flows.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Documentation</h1>
<ul>
<li><a href="index.html">Landing Page</a></li>
<li><a href="pre_process/index.html">Pre Process</a></li>
<li><a href="simulation/index.html">Simulation</a></li>
<li><a href="post_process/index.html">Post Process</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Authors</h1>
<p>This is the documentation for the MFC (Multicomponent Flow Code). The MFC is a simulation software for multi-component, multi-phase, and bubbly flows. MFC was first developed by the Colonius research group at Caltech. Now it is developed and maintained by the groups of Professors <a href="https://comp-physics.group">Spencer Bryngelson</a>, <a href="https://colonius.caltech.edu/">Tim Colonius</a>, and <a href="https://vivo.brown.edu/display/mrodri97">Mauro Rodriguez</a> (alphabetical). We try to maintain a list of current and past developers in the <a href="AUTHORS">AUTHORS</a> file!</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Publications</h1>
<h2><a class="anchor" id="autotoc_md4"></a>
Primary Paper</h2>
<p>The paper that describes the MFC's capabilities:</p><ul>
<li><a href="https://doi.org/10.1016/j.cpc.2020.107396">S. H. Bryngelson, K. Schmidmayer, V. Coralic, K. Maeda, J. Meng, T. Colonius (2021) Computer Physics Communications 4655, 107396 </a></li>
</ul>
<div class="fragment"><div class="line">@article{Bryngelson_2021,</div>
<div class="line">    title = {MFC: An open-source high-order multi-component, multi-phase, and multi-scale compressible flow solver},</div>
<div class="line">    author = {Spencer H. Bryngelson and Kevin Schmidmayer and Vedran Coralic and Jomela C. Meng and Kazuki Maeda and Tim Colonius},</div>
<div class="line">    journal = {Computer Physics Communications},</div>
<div class="line">    doi = {10.1016/j.cpc.2020.107396},</div>
<div class="line">    year = 2021,</div>
<div class="line">    month = {may},</div>
<div class="line">    publisher = {Elsevier {BV}},</div>
<div class="line">    pages = {107396},</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md5"></a>
Related publications</h2>
<p>Several publications have used the MFC in various stages of its development. A partial list is included here.</p>
<p>Journal papers:</p><ul>
<li><a href="https://arxiv.org/abs/2112.14172">S. H. Bryngelson, R. O. Fox, T. Colonius (2021) arXiv: 2112.14172. </a></li>
<li><a href="https://asa.scitation.org/doi/full/10.1121/10.0000746">S. H. Bryngelson and T. Colonius (2020) Journal of the Acoustical Society of America, Vol. 147, pp. 1126-1135 </a></li>
<li><a href="https://www.sciencedirect.com/science/article/pii/S0021999119307855">K. Schmidmayer, S. H. Bryngelson, T. Colonius (2020) Journal of Computational Physics, Vol. 402, 109080 </a></li>
<li><a href="http://colonius.caltech.edu/pdfs/BryngelsonSchmidmayerColonius2019.pdf">S. H. Bryngelson, K. Schmidmayer, T. Colonius (2019) International Journal of Multiphase Flow, Vol. 115, pp. 137-143  </a></li>
<li><a href="http://colonius.caltech.edu/pdfs/MaedaColonius2019.pdf">K. Maeda and T. Colonius (2019) Journal of Fluid Mechanics, Vol. 862, pp. 1105-1134 </a></li>
<li><a href="http://colonius.caltech.edu/pdfs/MaedaColonius2018c.pdf">K. Maeda and T. Colonius (2018) Journal of Computational Physics, Vol. 371, pp. 994-1017 </a></li>
<li><a href="http://colonius.caltech.edu/pdfs/MengColonius2018.pdf">J. C. Meng and T. Colonius (2018) Journal of Fluid Mechanics, Vol. 835, pp. 1108-1135 </a></li>
<li><a href="http://colonius.caltech.edu/pdfs/MaedaColonius2017.pdf">K. Maeda and T. Colonius (2017) Wave Motion, Vol. 75, pp. 36-49 </a></li>
<li><a href="http://colonius.caltech.edu/pdfs/MengColonius2015.pdf">J. C. Meng and T. Colonius (2015) Shock Waves, Vol. 25(4), pp. 399-414 </a></li>
<li><a href="http://colonius.caltech.edu/pdfs/CoralicColonius2014.pdf">V. Coralic and T. Colonius (2014) Journal of Computational Physics, Vol. 274, pp. 95-121 </a></li>
</ul>
<p>Ph.D. Disserations:</p><ul>
<li><a href="https://thesis.library.caltech.edu/11395/">J.-C. Veilleux (2019) Ph.D. thesis, California Institute of Technology </a></li>
<li><a href="https://thesis.library.caltech.edu/11007/">K. Maeda (2018) Ph.D. thesis, California Institute of Technology </a></li>
<li><a href="https://thesis.library.caltech.edu/9764/">J. Meng (2016) Ph.D. thesis, California Institute of Technology </a></li>
<li><a href="https://thesis.library.caltech.edu/8758/">V. Coralic (2014) Ph.D. thesis, California Institute of Technology </a></li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
Build Environment</h1>
<p>To fetch, build, and run MFC and its dependencies on a UNIX-like system, you must have installed common utilities such as GNU's Make, Python3, its development headers and libraries, a C/C++ compiler (GCC, NVHPC, etc., but <em>not Clang</em>), and an MPI wrapper (like Open MPI). Below are some commands for popular operating systems and package managers.</p>
<p><a href="https://www.anaconda.com/">Anaconda</a> may interfere with the building process. If an issue arises, you can either uninstall the affected Anaconda packages, change the ordering of directory paths in your <code>$PATH</code>, or make aliases to the correct binaries.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
*nix</h2>
<ul>
<li><b>Via <a href="https://wiki.debian.org/Aptitude">Aptitude</a>:</b></li>
</ul>
<div class="fragment"><div class="line">$ sudo apt update</div>
<div class="line">$ sudo apt upgrade</div>
<div class="line">$ sudo apt install tar wget make cmake gcc g++ \</div>
<div class="line">                    python3 python3-dev         \</div>
<div class="line">                    &quot;openmpi-*&quot; libopenmpi-dev</div>
</div><!-- fragment --><ul>
<li><b>Via <a href="https://wiki.archlinux.org/title/pacman">Pacman</a>:</b></li>
</ul>
<div class="fragment"><div class="line">$ sudo pacman -Syu</div>
<div class="line">$ sudo pacman -S base-devel coreutils  \</div>
<div class="line">                  git ninja gcc-fortran \</div>
<div class="line">                  cmake openmpi python3 \</div>
<div class="line">                  python-pip openssh    \</div>
<div class="line">                  python-virtualenv vim \</div>
<div class="line">                  wget tree</div>
</div><!-- fragment --><p>If you wish to build MFC using <a href="https://developer.nvidia.com/hpc-sdk">NVidia's NVHPC SDK</a>, follow the instructions <a href="https://developer.nvidia.com/nvidia-hpc-sdk-downloads">here</a>.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Windows</h2>
<p>On Windows, you can either use Intel Compilers with the standard Microsoft toolchain, <a href="https://docs.docker.com/get-docker/">Docker</a> or the <a href="https://docs.microsoft.com/en-us/windows/wsl/">Windows Subsystem for Linux (WSL)</a> for a Linux experience.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Windows + Intel (Native)</h3>
<p>Install the latest version of:</p><ul>
<li><a href="https://visualstudio.microsoft.com/">Microsoft Visual Studio Community</a></li>
<li><a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/base-toolkit-download.html">Intel® oneAPI Base Toolkit</a></li>
<li><a href="https://www.intel.com/content/www/us/en/developer/tools/oneapi/hpc-toolkit-download.html">Intel® oneAPI HPC Toolkit</a></li>
</ul>
<p>Then, in order to initialize your development environment, open a terminal window and run: </p><div class="fragment"><div class="line">&quot;C:\Program Files (x86)\Intel\oneAPI\setvars.bat&quot;</div>
</div><!-- fragment --><p>To follow this guide, please replace <code>./mfc.sh</code> with <code>mfc.bat</code> when running any commands. <code>./mfc.sh</code> is intended Unix-like systems. You will also have access to the <code>.sln</code> Microsoft Visual Studio solution files for an IDE (Integrated Development Environment).</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Windows + Docker</h3>
<p>See the instructions in the "Docker (Cross-Platform)" section of this document.</p>
<h3><a class="anchor" id="autotoc_md11"></a>
Windows + WSL</h3>
<p>Install the latest version of the <a href="https://docs.microsoft.com/en-us/windows/wsl/">Windows Subsystem for Linux (WSL)</a> as well as a distribution such as Ubuntu which can be found <a href="https://apps.microsoft.com/store/detail/ubuntu/9PDXGNCFSCZV">here</a>. Acquiring an interactive session is as simple as typing <code>wsl</code> in your command prompt, or alternatively, selecting the distribution from the dropdown menu available in the <a href="https://apps.microsoft.com/store/detail/windows-terminal/9N0DX20HK701">Microsoft Terminal</a>.</p>
<p>You can now follow the appropriate instructions for your distribution.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
MacOS (x86 and Apple Silicon)</h2>
<p><b>Note:</b> macOS remains the most difficult platform to consistently compile MFC on. If you run into issues, we suggest you try using Docker (instructions above).</p>
<ul>
<li><b>MacOS v10.15 (Catalina) or newer [ZSH]</b> (Verify with <code>echo $SHELL</code>)</li>
</ul>
<div class="fragment"><div class="line">$ touch ~/.zshrc</div>
<div class="line">$ open ~/.zshrc</div>
</div><!-- fragment --><ul>
<li><b>Older than MacOS v10.15 (Catalina) [BASH]</b> (Verify with <code>echo $SHELL</code>)</li>
</ul>
<div class="fragment"><div class="line">$ touch ~/.bash_profile</div>
<div class="line">$ open ~/.bash_profile</div>
</div><!-- fragment --><p>An editor should open. Please paste the following lines into it before saving the file. If you wish to use a version of GNU's GCC other than 11, modify the first assignment. These lines ensure that LLVM's Clang, and Apple's modified version of GCC, won't be used to compile MFC. Further reading on <code>open-mpi</code> incompatibility with <code>clang</code>-based <code>gcc</code> on macOS: <a href="https://stackoverflow.com/questions/27930481/how-to-build-openmpi-with-homebrew-and-gcc-4-9">here</a>. We do <em>not</em> support <code>clang</code> due to conflicts with our Silo dependency.</p>
<div class="fragment"><div class="line"># === MFC MPI Installation ===</div>
<div class="line">export MFC_GCC_VER=11</div>
<div class="line">export OMPI_MPICC=gcc-$MFC_GCC_VER</div>
<div class="line">export OMPI_CXX=g++-$MFC_GCC_VER</div>
<div class="line">export OMPI_FC=gfortran-$MFC_GCC_VER</div>
<div class="line">export CC=gcc-$MFC_GCC_VER</div>
<div class="line">export CXX=g++-$MFC_GCC_VER</div>
<div class="line">export FC=gfortran-$MFC_GCC_VER</div>
<div class="line"># === MFC MPI Installation ===</div>
</div><!-- fragment --><p><b>Close the open editor and terminal window</b>. Open a <b>new terminal</b> window before executing the commands bellow.</p>
<div class="fragment"><div class="line">$ brew install wget make python make cmake coreutils gcc@$MFC_GCC_VER</div>
<div class="line">$ HOMEBREW_MAKE_JOBS=$(nproc) brew install --cc=gcc-$MFC_GCC_VER --verbose --build-from-source open-mpi</div>
</div><!-- fragment --><p>They will download the dependencies MFC requires to build itself. <code>open-mpi</code> will be compiled from source, using the version of GCC we specified above with the environment variables <code>HOMEBREW_CC</code> and <code>HOMEBREW_CXX</code>. Building this package might take a while.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Docker (Cross-Platform)</h2>
<p>Docker is a lightweight, cross-platform, and performant alternative to Virtual Machines (VMs). We build a Docker Image that contains the packages required to build and run MFC on your local machine.</p>
<p>First install Docker and Git:</p><ul>
<li>Windows: <a href="https://docs.docker.com/get-docker/">Docker</a> + <a href="https://git-scm.com/downloads">Git</a>.</li>
<li>macOS: <code>brew install git docker</code> (requires <a href="https://brew.sh/">Homebrew</a>).</li>
<li>Other systems: <div class="fragment"><div class="line">$ sudo apt install git docker # Debian / Ubuntu via Aptitude</div>
<div class="line">$ sudo pacman -S git docker   # Arch Linux via Pacman</div>
</div><!-- fragment --></li>
</ul>
<p>Once Docker and Git are installed on your system, clone MFC with</p>
<div class="fragment"><div class="line">$ git clone https://github.com/MFlowCode/MFC</div>
<div class="line">$ cd MFC </div>
</div><!-- fragment --><p>To fetch the prebuilt Docker image and enter an interactive bash session with the recommended settings applied, run</p>
<div class="fragment"><div class="line">$ ./mfc.sh  docker # If on \*nix/macOS</div>
<div class="line">$ .\mfc.bat docker # If on Windows</div>
</div><!-- fragment --><p>We automatically mount and configure the proper permissions in order for you to access your local copy of MFC, available at <code>~/MFC</code>. You will be logged-in as the <code>me</code> user with root permissions.</p>
<p>:warning: The state of your container is entirely transient, except for the MFC mount. Thus, any modification outside of <code>~/MFC</code> should be considered as permanently lost upon session exit.</p>
<h1><a class="anchor" id="autotoc_md14"></a>
Fetch, Build, and Test</h1>
<p>MFC can be built without a helper script by directly running CMake but they (<code>mfc.sh</code> on Linux and <code>mfc.bat</code> on Windows) offer convenience features that assist in building, testing, optimization, as well as interactive and batch execution. To build MFC without a helper script, consult the <a href="CMakeLists.txt">CMakeLists.txt</a> file for a full list of options, as well as <a href="toolchain/dependencies/CMakeLists.txt">toolchain/dependencies/CMakeLists.txt</a> for a CMake superbuild file that fetches and builds MFC's main dependencies with supported versions.</p>
<ul>
<li><b>Fetch MFC:</b></li>
</ul>
<div class="fragment"><div class="line">$ git clone https://github.com/MFlowCode/MFC</div>
<div class="line">$ cd MFC</div>
</div><!-- fragment --><ul>
<li>**(Optional) Configure MFC defaults in <a href="defaults.yaml">defaults.yaml</a>:**</li>
</ul>
<p>If you wish, you can override MFC's default build parameters in <a href="defaults.yaml">defaults.yaml</a>, a file intended for user customization. This can greatly reduce the number of command-line arguments you have to pass to <a href="mfc.sh">mfc.sh</a>` in the following sections. You can do this at any time.</p>
<ul>
<li><b>Build MFC's codes in <code>release-cpu</code> mode with 8 threads:</b></li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh build -t pre_process simulation post_process -j 8</div>
</div><!-- fragment --><p>To build MFC in different configurations (herein, <em>modes</em>), the <code>-m &lt;mode&gt;</code> option can be specified to each call to <code>mfc.sh</code>. A full list of modes is located in <a href="defaults.yaml">defaults.yaml</a>. It can be modified to work with system, and additional modes can be created at your discretion. The default mode is <code>release-cpu</code> but you can use others such as <code>release-gpu</code>.</p>
<p><b>IMPORTANT NOTE</b>: This same mode will be used for any future commands such as <code>./mfc.sh test</code> and <code>./mfc.sh run</code> until you specify <code>-m</code> again (in any of these commands).</p>
<ul>
<li><b>Run MFC's tests in <code>release-cpu</code> mode with 8 threads:</b></li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh test -j 8</div>
</div><!-- fragment --><p>Please refer to the <a href="#testing-mfc">Testing</a> section of this document for more information.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
User Configuration (&lt;tt&gt;defaults.yaml&lt;/tt&gt;)</h2>
<p>The <code>mfc.sh</code> script used in the previous section is configured through the file named <code>defaults.yaml</code>.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Running MFC</h1>
<p>MFC can be run using <code>mfc.sh</code>'s <code>run</code> command. It supports both interactive and batch execution, the latter being designed for multi-socket systems, namely supercomputers, equipped with a scheduler such as PBS, SLURM, and LSF. A full (and updated) list of available arguments can be acquired with <code>./mfc.sh run -h</code>. Example Python input files can be found in the <a href="samples/">samples/</a> directory. They print a Python dictionary containing input parameters for MFC. Their contents, and a guide to filling them out, are documented in the user manual. A commented, tutorial script can also be found in <a href="samples/3D_sphbubcollapse/case.py">samples/3d_sphbubcollapse/</a>.</p>
<p>The skeleton for an input file may look like the following:</p>
<div class="fragment"><div class="line">#!/usr/bin/env python3</div>
<div class="line"> </div>
<div class="line">import json</div>
<div class="line"> </div>
<div class="line"># Configuring case dictionary</div>
<div class="line">print(json.dumps({</div>
<div class="line">  # Insert case parameters here</div>
<div class="line">  ...</div>
<div class="line">}))</div>
</div><!-- fragment --><p>Thus, you can run your case file with Python to view the computed case dictionary that will be processed by MFC when you run. This is particularly useful when computations are done in Python to generate the case.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Interactive Execution</h2>
<p>To run all stages of MFC, that is <a href="src/pre_process_code/">pre_process</a>, <a href="src/simulation_code/">simulation</a>, and <a href="src/post_process_code/">post_process</a> on the sample case <a href="samples/2D_shockbubble/">2D_shockbubble</a>,</p>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py</div>
</div><!-- fragment --><p>If you want to run a subset of the available stages, you can use the <code>-t</code> argument. To use multiple threads, use the <code>-n</code> option along with the number of threads you wish to use. If a (re)build is required, it will be done automatically, with the number of threads specified with the <code>-j</code> option.</p>
<p>For example,</p>
<ul>
<li>Running <a href="src/pre_process_code/">pre_process</a> with 2 cores:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -t pre_process -n 2</div>
</div><!-- fragment --><ul>
<li>Running <a href="src/simulation_code/">simulation</a> and <a href="src/post_process_code/">post_process</a> using 4 cores:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -t simulation post_process -n 4</div>
</div><!-- fragment --><p>Most parameters have sensible defaults which can be overridden in <a href="defaults.yaml">defaults.yaml</a>:</p>
<p><a href="https://github.com/MFlowCode/MFC-develop/blob/d74e714b08562a9f8f815112e05df54c99c8c18f/defaults.yaml#L12-L21">https://github.com/MFlowCode/MFC-develop/blob/d74e714b08562a9f8f815112e05df54c99c8c18f/defaults.yaml#L12-L21</a></p>
<p>On some computer clusters, MFC might select the wrong MPI program to execute your application because it uses a general heuristic for its selection. Notably, <code>srun</code> is known to fail on some SLURM systems when using GPUs or MPI implementations from different vendors, whereas <code>mpirun</code> functions properly. To override and manually specify which MPI program you wish to run your application with, please use the <code>-b &lt;program name&gt;</code> option (i.e <code>--binary</code>).</p>
<p>Additional flags can be appended to the MPI executable call using the <code>-f</code> (i.e <code>--flags</code>) option.</p>
<p>Please refer to <code>./mfc.sh run -h</code> for a complete list of arguments and options, along with their defaults.</p>
<h2><a class="anchor" id="autotoc_md18"></a>
Batch Execution</h2>
<p>The MFC detects which scheduler your system is using and handles the creation and execution of batch scripts. The batch engine is requested with the <code>-e batch</code> option. Whereas the interactive engine can execute all of MFC's codes in succession, the batch engine requires you to only specify one target with the <code>-t</code> option. The number of nodes and GPUs can, respectively be specified with the <code>-N</code> (i.e <code>--nodes</code>) and <code>-g</code> (i.e <code>--gpus-per-node</code>) options.</p>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -e batch -N 2 -n 4 -g 4 -t simulation</div>
</div><!-- fragment --><p>Other useful arguments include:</p>
<ul>
<li><code>-# &lt;job name&gt;</code> to name your job. (i.e <code>--name</code>)</li>
<li><code>-@ sample@example.com</code> to receive emails from the scheduler. (i.e <code>--email</code>)</li>
<li><code>-w hh:mm:ss</code> to specify the job's maximum allowed walltime. (i.e <code>--walltime</code>)</li>
<li><code>-a &lt;account name&gt;</code> to identify the account to be charged for the job. (i.e <code>--account</code>)</li>
<li><code>-p &lt;partition name&gt;</code> to select the job's partition. (i.e <code>--partition</code>)</li>
</ul>
<p>Since some schedulers don't have a standardized syntax to request certain resources, MFC can only provide support for a restricted subset of common configuration options. If MFC fails to execute on your system, or if you wish to adjust how the program runs and resources are requested to be allocated, you are invited to modify the template batch script for your queue system. Upon execution of <code>./mfc.sh run</code>, MFC fills in the template with runtime parameters, to generate the batch file it will submit. These files are located in the <a href="templates/">templates</a> directory. To request GPUs, modification of the template will be required on most systems.</p>
<ul>
<li>Lines that begin with <code>#&gt;</code> are ignored and won't figure in the final batch script, not even as a comment.</li>
<li>Statements of the form <code>${expression}</code> are string-replaced to provide runtime parameters, most notably execution options. They reference the variables in the same format as those under the "run" section of <a href="defaults.yaml">defaults.yaml</a>, replacing <code>-</code> for <code>_</code>. You can perform therein any Python operation recognized by the built-in <code>expr()</code> function.</li>
</ul>
<p>As an example, one might request GPUs on a SLURM system using the following:</p>
<div class="fragment"><div class="line">#SBATCH --gpus=v100-32:{gpus_per_node*nodes}</div>
</div><!-- fragment --><ul>
<li>Statements of the form <code>{MFC::expression}</code> tell MFC where to place the common code, across all batch files, that is required for proper execution. They are not intended to be modified by users.</li>
</ul>
<p><b>Disclaimer</b>: IBM's JSRUN on LSF-managed computers does not use the traditional node-based approach to allocate resources. Therefore, the MFC constructs equivalent resource-sets in task and GPU count.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
Example Runs</h2>
<ul>
<li>Oak Ridge National Laboratory's <a href="https://www.olcf.ornl.gov/summit/">Summit</a>:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -e batch    \</div>
<div class="line">               -N 2 -n 4 -g 4 -t simulation -a &lt;redacted&gt;</div>
</div><!-- fragment --><ul>
<li>University of California, San Diego's <a href="https://www.sdsc.edu/services/hpc/expanse/">Expanse</a>:</li>
</ul>
<div class="fragment"><div class="line">$ ./mfc.sh run samples/2D_shockbubble/case.py -e batch -p GPU -t simulation \</div>
<div class="line">               -N 2 -n 8 -g 8 -f=&quot;--gpus=v100-32:16&quot; -b mpirun –w 00:30:00</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md20"></a>
Testing MFC</h1>
<p>To run MFC's test suite, run </p><div class="fragment"><div class="line">$ ./mfc.sh test -j &lt;thread count&gt;</div>
</div><!-- fragment --><p>It will generate and run test cases, comparing their output to that of previous runs from versions of MFC considered to be accurate. <em>golden files</em>, stored in the <code>tests/</code> directory contain this data, by aggregating <code>.dat</code> files generated when running MFC. A test is considered passing when our error tolerances are met, in order to maintain a high level of stability and accuracy. Run <code>./mfc.sh test -h</code> for a full list of accepted arguments.</p>
<p>Most notably, you can consult the full list of tests by running </p><div class="fragment"><div class="line">$ ./mfc.sh test -l</div>
</div><!-- fragment --><p>To restrict to a given range, use the <code>--from</code> (<code>-f</code>) and <code>--to</code> (<code>-t</code>) options. To run a (non-contiguous) subset of tests, use the <code>--only</code> (<code>-o</code>) option instead.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Creating Tests</h2>
<p>To (re)generate <em>golden files</em>, append the <code>-g</code> (i.e <code>--generate</code>) option: </p><div class="fragment"><div class="line">$ ./mfc.sh test -g -j 8</div>
</div><!-- fragment --><p>Adding a new test case can be done by modifying <a href="toolchain/mfc/tests/cases.py">cases.py</a>. The function <code>generate_cases</code> is responsible for generating the list of test cases. Loops and conditionals are used to vary parameters, whose defaults can be found in the <code>BASE_CFG</code> case object within <a href="toolchain/mfc/tests/case.py">case.py</a>. The function operates on two variables:</p>
<ul>
<li><code>stack</code>: A stack that holds the variations to the default case parameters. By pushing and popping the stack inside loops and conditionals, it is easier to nest test case descriptions, as it holds the variations that are common to all future test cases within the same indentation level (in most scenarios).</li>
<li><code>cases</code>: A list that holds fully-formed <code>Case</code> objects, that will be returned at the end of the function.</li>
</ul>
<p>Internally a test case is described as: </p><div class="fragment"><div class="line">@dataclasses.dataclass(init=False)</div>
<div class="line">class Case:</div>
<div class="line">    trace:  str</div>
<div class="line">    params: dict</div>
<div class="line">    ppn:    int</div>
</div><!-- fragment --><p>where:</p><ul>
<li>The <code>trace</code> is a string that contains a human-readable description of what parameters were varied, or more generally what the case is meant to test. <b>Each <code>trace</code> must be distinct.</b></li>
<li><code>params</code> is the fully resolved case dictionary, as would appear in a Python case input file.</li>
<li><code>ppn</code> is the number of processes per node to use when running the case.</li>
</ul>
<p>To illustrate, consider the following excerpt from <code>generate_cases</code>:</p>
<div class="fragment"><div class="line">for weno_order in [3, 5]:</div>
<div class="line">  stack.push(f&quot;weno_order={weno_order}&quot;, {&#39;weno_order&#39;: weno_order})</div>
<div class="line"> </div>
<div class="line">  for mapped_weno, mp_weno in [(&#39;F&#39;, &#39;F&#39;), (&#39;T&#39;, &#39;F&#39;), (&#39;F&#39;, &#39;T&#39;)]:</div>
<div class="line">      stack.push(f&quot;(mapped_weno={mapped_weno},mp_weno={mp_weno})&quot;, {</div>
<div class="line">          &#39;mapped_weno&#39;: mapped_weno,</div>
<div class="line">          &#39;mp_weno&#39;:     mp_weno</div>
<div class="line">      })</div>
<div class="line"> </div>
<div class="line">      if not (mp_weno == &#39;T&#39; and weno_order != 5):</div>
<div class="line">          cases.append(create_case(stack, &#39;&#39;, {}))</div>
<div class="line"> </div>
<div class="line">      stack.pop()</div>
<div class="line"> </div>
<div class="line">  stack.pop()</div>
</div><!-- fragment --><p>When pushing to the stack, or creating a new case with the <code>create_case</code> function, you must specify:</p><ul>
<li><code>stack</code>: The current stack.</li>
<li><code>trace</code>: A human-readable string describing what you are currently varying.</li>
<li><code>variations</code>: A Python dictionary with case parameter variations.</li>
<li>(Optional) <code>ppn</code>: The number of processes per node to use (default is 1).</li>
</ul>
<p>If a trace is empty (that is, the empty string <code>""</code>), it will not appear in the final trace, but any case parameter variations associated with it will still be applied.</p>
<p>Finally, the case is appended to the <code>cases</code> list, which will be returned by the <code>generate_cases</code> function.</p>
<h1><a class="anchor" id="autotoc_md22"></a>
Development</h1>
<h2><a class="anchor" id="autotoc_md23"></a>
Fypp</h2>
<p>MFC uses <a href="https://github.com/aradi/fypp">Fypp</a>, a Python-based Fortran preprocessor to reduce code duplication. <code>.fpp</code> files are converted into regular <code>.f90</code> files as part of the build process. Documentation for Fypp can be found <a href="https://fypp.readthedocs.io/en/stable/">here</a>.</p>
<p>You can inspect the generated <code>.f90</code> files in <code>src/&lt;code name&gt;/autogen/</code>.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Useful Scripts</h1>
<h2><a class="anchor" id="autotoc_md25"></a>
Loading Modules</h2>
<p>On computer systems that run using environment modules, with implementations like <a href="https://github.com/TACC/Lmod">TACC's Lmod</a>, MFC provides a script that can load modules that have been used by contributors.</p>
<div class="fragment"><div class="line">$ . ./mfc.sh load</div>
</div><!-- fragment --><p>The list of modules offered by a system is subject to change. The aforementioned script serves as a convenient way to load modules that should work for most users of MFC.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
OpenACC Memory Profiling</h2>
<p>You can append <code>-DMFC_MEMORY_DUMP</code> to <code>release-gpu</code>'s Fortran compiler options in <a href="defaults.yaml">defaults.yaml</a> to make the <a href="src/simulation_code/">simulation code</a> call <code>acc_present_dump()</code> at various stages of program execution to obtain a printout of on-device memory usage. The <a href="misc/mem_parse.sh">mem_parse.sh</a> script can be given as an argument the path to a file containing MFC's output, in order to aggregate the data and produce tables with formatted output.</p>
<h1><a class="anchor" id="autotoc_md27"></a>
License</h1>
<p>Copyright 2022. MFC is under the MIT license (see [LICENSE](LICENSE) file for full text).</p>
<h1><a class="anchor" id="autotoc_md28"></a>
Acknowledgements</h1>
<p>The development of the MFC was supported in part by multiple current and past grants from the US Office of Naval Research (ONR), the US National Institute of Health (NIH), and the US National Science Foundation (NSF). MFC computations utilize the Extreme Science and Engineering Discovery Environment (XSEDE), under allocations TG-CTS120005 (PI Colonius) and TG-PHY210084 (PI Bryngelson) and ORNL Summit under allocation CFD154 (PI Bryngelson). </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
